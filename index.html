<!DOCTYPE html>
<html>
  <head>
    <title>Map Motion</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <link rel="shortcut icon" href="../favicon.ico">

    <style>
      html, body, #map-canvas {
        margin: 0;
        padding: 0;
        height: 95%;
      }

      #results {
        font-family: Arial, Helvetica, sans-serif;
        position: absolute;
        right: 5px;
        top: 50%;
        margin-top: -195px;
        height: 380px;
        width: 200px;
        padding: 5px;
        z-index: 5;
        border: 1px solid #999;
        background: #fff;
      }
      h2 {
        font-size: 22px;
        margin: 0 0 5px 0;
      }
      ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
        height: 321px;
        width: 200px;
        overflow-y: scroll;
      }
      li {
        background-color: #f1f1f1;
        padding: 10px;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
      }
      li:nth-child(odd) {
        background-color: #fcfcfc;
      }
      #more {
        width: 100%;
        margin: 5px 0 0 0;
      }
    </style>
    <!--key=AIzaSyCrWGtAkWaNG14yjjbrhfLruCxWC7EvyVQ-->
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places"></script>
    <script src="https://js.leapmotion.com/leap-0.6.4.min.js"></script>
    <script src="https://js.leapmotion.com/leap-plugins-0.1.6.js"></script>
    <script src="https://js.leapmotion.com/leap.rigged-hand-0.1.4.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script>
var map;
var placesList;
var service;
var infowindow;
var markers = [];
var start;
var end;
var pins = 0;
var waypts = [];
var directionsDisplay;
var directionsService = new google.maps.DirectionsService();
var leftHandPrev;
var separationStart;
var MAX_ZOOM = 22;
var SEPARATION_SCALING = 1.25;
var LEFT_HAND = 0, RIGHT_HAND = 1;
var X = 0, Y = 1, Z = 2;

var streetView = false;
function palmPosition(hand) {
    var position = hand.palmNormal;
    var orientation;
    if (position[1] > 0.75)
        orientation = "up";
    else
        orientation = "down";
    
    return orientation;
}

function move(frame) {
    // Look for any circle gestures and process the zoom
    // TODO: filter out multiple circle gestures per frame
    if(frame.valid && frame.gestures.length > 0){
        frame.gestures.forEach(function(gesture){
            filterGesture("circle", zoom)(frame, gesture);
            filterGesture("keyTap", dropPin)(frame, gesture);
            filterGesture("screenTap", removeAllPins)(frame, gesture);
            filterGesture("swipe", switchMode)(frame, gesture);
        });
    }
    markHands(frame);
        
    if (streetView === false) {
    
        // Palm up to activate StreetView.  Two palms down to go back to map.
        if (frame.hands.length == 1 && streetView === false) {
            if (palmPosition(frame.hands[0]) == "up") {
                var hand = frame.hands[0];
                var scaling = (4.0 / Math.pow(2, map.getZoom()-1));
                var bounds = map.getBounds();
                if(!bounds) { return; }
                var origin = new google.maps.LatLng(bounds.getSouthWest().lat(), bounds.getCenter().lng());
                var myLatlng = new google.maps.LatLng(origin.lat() + ((hand.stabilizedPalmPosition[1] - HEIGHT_OFFSET) * scaling), origin.lng() + (hand.stabilizedPalmPosition[0] * scaling));
                var panorama = map.getStreetView();
                map.set('streetViewControl', true);
                panorama.setPosition(myLatlng);
                panorama.setVisible(true);
                streetView = true;
                return;
            }
        }

        // if there is one hand grabbing...
        if(frame.hands.length > 0 && isGripped(frame.hands[LEFT_HAND])) {
          var leftHand = frame.hands[LEFT_HAND];
          var rightHand = frame.hands.length > 1 ? frame.hands[RIGHT_HAND] : undefined;
          var separation;
          
          // If there was no previous closed position, capture it and exit
          if(leftHandPrev == null) {
            leftHandPrev = leftHand;
            return;
          }
          // if there is a right hand and its gripped...
          if(rightHand) {
            if(isGripped(rightHand)) {
              separation = Math.sqrt(
                                Math.pow(rightHand.stabilizedPalmPosition[X] - leftHand.stabilizedPalmPosition[X], 2) + 
                                Math.pow(rightHand.stabilizedPalmPosition[Y] - leftHand.stabilizedPalmPosition[Y], 2)
                              );
              // console.log("separation = " + separation + " ("+separationStart+")");
              // ...and no previous separation, capture and exit
              if(separationStart == null) {
                separationStart = separation;
                return;
              }
              // Calculate if we need to change the zoom level
              var currentZoom = map.getZoom();
              if(currentZoom > 1 && separation < (separationStart / SEPARATION_SCALING) ) {
                map.setZoom( currentZoom - 1 );
                separationStart = separation;
              } else if( currentZoom < MAX_ZOOM && separation > (SEPARATION_SCALING * separationStart) ) {
                map.setZoom( currentZoom + 1 );
                separationStart = separation;
              }
            // If the right hand is not gripped...
            } else if(separationStart != null) {
              separationStart = null;
            }
          }
          // Calculate how much the hand moved
          var dX = leftHandPrev.stabilizedPalmPosition[X] - leftHand.stabilizedPalmPosition[X];
          var dY = leftHandPrev.stabilizedPalmPosition[Y] - leftHand.stabilizedPalmPosition[Y];
          // console.log("Movement: " + dX + ","+dY);
          var center = map.getCenter();
          var scaling = 4.0 / Math.pow(2, map.getZoom()-1);
          var newLat = center.lat() + dY * scaling;
          var newLng = center.lng() + dX * scaling;
          var newCenter = new google.maps.LatLng(newLat, newLng);
          
          // console.log(newCenter)
          map.setCenter(newCenter);
          leftHandPrev = leftHand;
        } else {
          // If the left hand is not in a grab position, clear the last hand position
          if(frame.hands.length > LEFT_HAND && !isGripped(frame.hands[LEFT_HAND]) && leftHandPrev != null) {
            leftHandPrev = null;
          }
          // if the right hand is not in a grab position, clear the separation
          if(frame.hands.length > RIGHT_HAND && !isGripped(frame.hands[RIGHT_HAND]) && separationStart != null) {
            separationStart = null;
          }
           // console.log("Clearing lastHand");
        }
    
    
    }
    
    else {
        // Two palms down to exit StreetView and return to map.
        if (frame.hands.length === 2 && streetView === true) {
            if (palmPosition(frame.hands[0]) === 'down' && palmPosition(frame.hands[1]) === 'down') {
                map.set('streetViewControl', false);
                var panorama = map.getStreetView();
                panorama.setVisible(false);
                streetView = false;
                return;
            }
        }
    }

    
}
var handMarkers = [];
var HEIGHT_OFFSET = 150;
var BASE_MARKER_SIZE_GRIPPED = 350000, BASE_MARKER_SIZE_UNGRIPPED = 500000;
function markHands(frame) {
    var scaling = (4.0 / Math.pow(2, map.getZoom()-1));
      var bounds = map.getBounds();
      // FIXME: Sometimes this gets run too early, just exit if its too early.
      if(!bounds) { return; }
      var origin = new google.maps.LatLng(bounds.getSouthWest().lat(), bounds.getCenter().lng());
      var hands = frame.hands;
      for(var i in hands) {
          if(hands.hasOwnProperty(i)) {
            // Limit this to 2 hands for now
            if(i > RIGHT_HAND) {
              return;
            }
            var hand = hands[i];
            newCenter = new google.maps.LatLng(origin.lat() + ((hand.stabilizedPalmPosition[1] - HEIGHT_OFFSET) * scaling), origin.lng() + (hand.stabilizedPalmPosition[0] * scaling));
            // console.log(center.lat() + "," + center.lng());
            // console.log(newCenter.lat() + "," + newCenter.lng());
            var gripped = isGripped(hand);
            var baseRadius = gripped ? BASE_MARKER_SIZE_GRIPPED : BASE_MARKER_SIZE_UNGRIPPED;
            var handColor = getHandColor(hand);
            var handMarker = handMarkers[i];
            if(!handMarker) {
              handMarker = new google.maps.Circle();
              handMarkers[i] = handMarker;
            }
            handMarker.setOptions({
              strokeColor: handColor,
              strokeOpacity: 0.8,
              strokeWeight: 2,
              fillColor: handColor,
              fillOpacity: 0.35,
              map: map,
              center: newCenter,
              radius: baseRadius * scaling
            });
          }
      }
}

function calcRoute() {
  //alert(start);
  //alert(end);
  var request = {
      origin:start,
      destination:end,
      waypoints:waypts,
      optimizeWaypoints: true,
      travelMode: google.maps.TravelMode.DRIVING
  };
  directionsService.route(request, function(response, status) {
    if (status == google.maps.DirectionsStatus.OK) {
      //alert("sd");
      directionsDisplay.setDirections(response);
    }
  });
  directionsDisplay.setMap(map);
}

function dropPin(frame, keyTapGesture){
  //alert("Drop Pin");
  var scaling = (4.0 / Math.pow(2, map.getZoom()-1));
  var bounds = map.getBounds();
  if(!bounds) { return; }
  var origin = new google.maps.LatLng(bounds.getSouthWest().lat(), bounds.getCenter().lng());
  var hand = frame.hands[0];
  var myLatlng = new google.maps.LatLng(origin.lat() + ((hand.stabilizedPalmPosition[1] - HEIGHT_OFFSET) * scaling), origin.lng() + (hand.stabilizedPalmPosition[0] * scaling));
  //alert(myLatlng);
  var marker = new google.maps.Marker({
      position: myLatlng,
      map: map,
      title: 'Hello World!'
  });
  markers.push(marker);
  if(pins == 0){
    start = myLatlng;
  }else if(pins == 1){
    end = myLatlng;
    //alert("cal");
    calcRoute();
  }else if(pins >= 2){
    for (var i = 2; i <= pins; i++) {
      waypts.push({
          location:myLatlng,
          stopover:true
      });
    }
    calcRoute();
  }
  pins = pins + 1;


  markers.push(marker);
}

function setAllMap(map){
	for (var i = 0; i < markers.length; i++){
		markers[i].setMap(map);
	}
}

function clearMarkers(){
	setAllMap(null);
}

function removeAllPins(frame, screenTapGesture){

  	clearMarkers();
  	markers = [];
    waypts=[];
    start=null;
    end=null;
    pins=0;
    directionsDisplay.setMap();
}

function switchMode(frame, swipeGesture){

  //Classify swipe as either horizontal or vertical
  var isHorizontal = Math.abs(swipeGesture.direction[0]) > Math.abs(swipeGesture.direction[1]);
  //Classify as right-left or up-down
  if(isHorizontal){
      if(swipeGesture.direction[0] > 0){
          var swipeDirection = "right";
      } else {
          var swipeDirection = "left";
      }
  } else { //vertical
      if(swipeGesture.direction[1] > 0){
          var swipeDirection = "up";
      } else {
          var swipeDirection = "down";
      }                  
  }
  if(swipeDirection=="right"){
        map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
  }else if(swipeDirection=="left"){
      map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
  }else if(swipeDirection=="up"){
      map.setMapTypeId(google.maps.MapTypeId.HYBRID);
  }else if(swipeDirection=="down"){
      map.setMapTypeId(google.maps.MapTypeId.TERRAIN);
  }
}

var zoomLevelAtCircleStart;
var INDEX_FINGER = 1;
function zoom(frame, circleGesture) {
    // Only zoom based on one index finger
    if(circleGesture.pointableIds.length == 1 &&
            frame.pointable(circleGesture.pointableIds[0]).type == INDEX_FINGER) {
        switch(circleGesture.state) {
            case "start":
                zoomLevelAtCircleStart = map.getZoom();
            // fall through on purpose...
            case "update":
                // figure out if we need to change the zoom level;
                var zoomChange = Math.floor(circleGesture.progress);
                var currentZoom = map.getZoom();
                var zoomDirection = isClockwise(frame, circleGesture) ? zoomChange : -zoomChange;
                if(zoomLevelAtCircleStart + zoomDirection != currentZoom) {
                    var newZoom = zoomLevelAtCircleStart + zoomDirection;
                    if(newZoom >= 0 && newZoom <= MAX_ZOOM) {
                        map.setZoom(newZoom);
                    }
                }
                break;
            case "stop":
                zoomLevelAtCircleStart = null;
                break;
        }
    }
}

function createMarkers(places) {
  var bounds = new google.maps.LatLngBounds();

  for (var i = 0, place; place = places[i]; i++) {
    var image = {
      url: place.icon,
      size: new google.maps.Size(71, 71),
      origin: new google.maps.Point(0, 0),
      anchor: new google.maps.Point(17, 34),
      scaledSize: new google.maps.Size(25, 25)
    };
    
    var mytext = place.name;
    var myinfowindow = new google.maps.InfoWindow({
        content: mytext
    });

    var marker = new google.maps.Marker({
      map: map,
      icon: image,
      title: place.name,
      position: place.geometry.location,
      infowindow: myinfowindow,
      clickable: true
    });
    marker.infowindow.open(map,marker);
    var request =  {
      reference: place.reference
    };

    google.maps.event.addListener(marker,'click',function(){
      this.infowindow.open(map, this);
    });
    

    placesList.innerHTML += '<li>' + place.name + '</li>';

    bounds.extend(place.geometry.location);
  }
  map.fitBounds(bounds);
}

function showNearByPOI(){
  /*
  var scaling = (4.0 / Math.pow(2, map.getZoom()-1));
  var bounds = map.getBounds();
  if(!bounds) { return; }
  var origin = new google.maps.LatLng(bounds.getSouthWest().lat(), bounds.getCenter().lng());
  var hand = frame.hands[0];
  var myLatlng = new google.maps.LatLng(origin.lat() + ((hand.stabilizedPalmPosition[1] - HEIGHT_OFFSET) * scaling), origin.lng() + (hand.stabilizedPalmPosition[0] * scaling));
  */
  var myOrigin = map.getCenter();
  var request = {
    location: myOrigin,
    radius: 500,
    types: ['store']
  };
  service.nearbySearch(request, callback);
}

function callback(results, status, pagination) {
  if (status != google.maps.places.PlacesServiceStatus.OK) {
    return;
  } else {
    createMarkers(results);

    if (pagination.hasNextPage) {
      var moreButton = document.getElementById('more');

      moreButton.disabled = false;

      google.maps.event.addDomListenerOnce(moreButton, 'click',
          function() {
        moreButton.disabled = true;
        alert("more");
        pagination.nextPage();
      });
    }
  }
}

function initialize() {
  directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true});
  var myOrigin = new google.maps.LatLng(34.0737354, -118.4455506);
  var mapOptions = {
    zoom: 15,
    center: myOrigin,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    mapTypeControlOptions: {
        position: google.maps.ControlPosition.TOP_LEFT
    }
  };
  map = new google.maps.Map(document.getElementById('map-canvas'),mapOptions);
  map.setTilt(45);

  var request = {
    location: myOrigin,
    radius: 500,
    types: ['store']
  };

  placesList = document.getElementById('places');
  infowindow = new google.maps.InfoWindow();
  service = new google.maps.places.PlacesService(map);
  service.nearbySearch(request, callback);
  //showNearByPOI();
  directionsDisplay.setMap(map);
  // listen to Leap Motion
  Leap.loop({enableGestures: true}, move);
}
// ==== utility functions =====
/** Returns the truth that a Leap Motion API Hand object is currently in a gripped or "grabbed" state.
*/
function isGripped(hand) {
  return hand.grabStrength == 1.0;
}

function isPinched(hand) {
  return hand.pinchStrength == 1.0;
}
function getHandColor(hand) {
    if(isGripped(hand)) {
        return "rgb(0,119,0)";
    } else {
        var tint = Math.round((1.0 - hand.grabStrength) * 119);
        tint = "rgb(119," + tint + "," + tint + ")";
        return tint;
    }
}
function filterGesture(gestureType, callback) {
    return function(frame, gesture) {
        if(gesture.type == gestureType) {
            callback(frame, gesture);
        }
    }
}
function isClockwise(frame, gesture) {
    var clockwise = false;
    var pointableID = gesture.pointableIds[0];
    var direction = frame.pointable(pointableID).direction;
    var dotProduct = Leap.vec3.dot(direction, gesture.normal);
    if (dotProduct  >  0) clockwise = true;
    return clockwise;
}
google.maps.event.addDomListener(window, 'load', initialize);
    </script>

  </head>
  <body>

    <div id="map-canvas"></div>
    <div id="results">
      <h2>Results</h2>
      <ul id="places"></ul>
      <button id="more">More results</button>
    </div>
    <form method="get" action="http://www.google.com/search">
     <input type="text" name="q" size="30" x-webkit-speech />
     <input type="submit" value="Search" />
    </form>
    <button id="lookup" onclick="showNearByPOI()">Points of Interests</button>
    <p>Here we are</p>
  </body>
</html>
